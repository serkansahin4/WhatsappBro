<!DOCTYPE html>
<html>
<head>
    <link href="~/bootstrap/css/bootstrap.css" rel="stylesheet" />
    <link href="~/bootstrap/css/reset.css" rel="stylesheet" />

</head>
<body>

    <style>
        .vertical-center {
            top: 0px;
            left: 0px;
            position: fixed;
            width: 100%;
            height: 100%;
            display: flex;
            gap: 10px;
        }

        .messages {
            width: 350px;
            height: 100%;
            background-color: white;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            position: relative;
            border-right: 1px solid grey;
        }

        .messages__header {
        }

        .search {
            outline: none;
            border-bottom: 1px solid grey;
            border-radius: 0px;
        }



        .messages__body {
            flex: 1;
            overflow-y: auto;
            height: 100%;
        }

        .user-container {
            width: 100%;
            background-color: white;
            display: flex;
            justify-content: start;
            flex-direction: row;
            align-items: center;
            border: 1px solid grey;
            cursor: pointer;
        }

            .user-container:hover {
                background-color: aliceblue;
            }

        .user-container__user-logo {
            padding: 5px 10px;
        }

        .user-container__user-name {
            padding: 5px;
            display: flex;
            align-content: space-between;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            height: 100%;
        }

        .messages__footer {
            width: 100%;
            position: absolute;
            bottom: 0px;
            border-top: 1px solid gray;
            display: flex;
            justify-content: space-around;
            background-color: white;
            height: 55px;
        }

        .option {
            display: flex;
            flex-direction: column;
            justify-items: center;
            align-items: center;
            position: relative;
            box-sizing: content-box;
            width: 100%;
            padding: 10px;
            cursor: pointer;
        }

        .option--selected{
            background-color:darkgreen;
            color:white;
            
        }

        .option--selected path{
            fill:white;
        }

        .option-friends:hover {
            background-color: darkgreen;
            color: white;
            fill: white;
        }

            .option-friends:hover path {
                fill: white;
            }

        .option-messages:hover {
            background-color: darkgreen;
            color: white;
            fill: white;
        }

            .option-messages:hover path {
                fill: white;
            }

        .option__notification {
            position: absolute;
            bottom: 0px;
        }

        .bracket {
            border: 1px solid gray;
            width: 0.5px;
        }


        .messages-explain {
            width: 100%;
            height: 100%;
            background-color: white;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .messages-explain__content {
            border: 1px solid gray;
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }

        .messages-explain__messagebox {
            padding: 10px;
            border: 1px solid gray;
        }

        .message-receiver__content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

            .message-receiver__content p {
                border-radius: 50px;
                padding: 5px 15px 5px 10px;
            }

        .message-sender__content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

            .message-sender__content p {
                border-radius: 50px;
                padding: 5px 15px 5px 10px;
            }
    </style>
    <div class="vertical-center">
        <div class="messages">
            <div class="messages__header">
            </div>
            <div class="messages__container">
                <div class="message__friendlist">
                    <div class="search-user">
                        <div class="d-flex justify-content-end align-items-center gap-2" style="position:relative; background-color:beige;">
                            <h6 class="m-0">Arkadaş ekle</h6>
                            <button class="btn btn-success btn-open-searchcontainer">+</button>
                        </div>

                        <div class="searchcontainer d-flex flex-column w-100" style="position:absolute; z-index:10; background-color:beige;">
                            <div class="d-flex w-100">
                                <input type="text" class="input-searchcontainer form-control" placeholder="Aranacak kullanıcı adı..." />
                            </div>

                            <div style="overflow-y:hidden; max-height:300px;">
                                <ul class="searchcontainer-explain" style="list-style:none; padding-left:0px  !important; margin-bottom:0px;">
                                </ul>
                            </div>
                        </div>
                        <div class="messages__friendlist-friends d-flex flex-column w-100" style="position:absolute;">
                            <div style="overflow-y:hidden;  background-color:white;">
                                <ul class="messages__friendlist-friends-explain" style="list-style:none; padding-left:0px  !important;">
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="messages__body">
                </div>
            </div>

            <div class="messages__footer">
                <div class="option option-profile" style="background-color:lightgrey;">
                    <img src="~/images/indir.png" width="25px" />
                    <small class="option__notification">Profil</small>
                </div>
                <div class="option option-friends">
                    <svg xmlns="http://www.w3.org/2000/svg" height="20" width="25" viewBox="0 0 640 512"><path fill="#5db0c0" d="M96 128a128 128 0 1 1 256 0A128 128 0 1 1 96 128zM0 482.3C0 383.8 79.8 304 178.3 304h91.4C368.2 304 448 383.8 448 482.3c0 16.4-13.3 29.7-29.7 29.7H29.7C13.3 512 0 498.7 0 482.3zM609.3 512H471.4c5.4-9.4 8.6-20.3 8.6-32v-8c0-60.7-27.1-115.2-69.8-151.8c2.4-.1 4.7-.2 7.1-.2h61.4C567.8 320 640 392.2 640 481.3c0 17-13.8 30.7-30.7 30.7zM432 256c-31 0-59-12.6-79.3-32.9C372.4 196.5 384 163.6 384 128c0-26.8-6.6-52.1-18.3-74.3C384.3 40.1 407.2 32 432 32c61.9 0 112 50.1 112 112s-50.1 112-112 112z" /></svg>
                    <small class="option__notification">5</small>
                </div>
                <div class="option option-messages">
                    <svg xmlns="http://www.w3.org/2000/svg" height="20" width="25" viewBox="0 0 640 512"><path fill="#78c481" d="M88.2 309.1c9.8-18.3 6.8-40.8-7.5-55.8C59.4 230.9 48 204 48 176c0-63.5 63.8-128 160-128s160 64.5 160 128s-63.8 128-160 128c-13.1 0-25.8-1.3-37.8-3.6c-10.4-2-21.2-.6-30.7 4.2c-4.1 2.1-8.3 4.1-12.6 6c-16 7.2-32.9 13.5-49.9 18c2.8-4.6 5.4-9.1 7.9-13.6c1.1-1.9 2.2-3.9 3.2-5.9zM0 176c0 41.8 17.2 80.1 45.9 110.3c-.9 1.7-1.9 3.5-2.8 5.1c-10.3 18.4-22.3 36.5-36.6 52.1c-6.6 7-8.3 17.2-4.6 25.9C5.8 378.3 14.4 384 24 384c43 0 86.5-13.3 122.7-29.7c4.8-2.2 9.6-4.5 14.2-6.8c15.1 3 30.9 4.5 47.1 4.5c114.9 0 208-78.8 208-176S322.9 0 208 0S0 78.8 0 176zM432 480c16.2 0 31.9-1.6 47.1-4.5c4.6 2.3 9.4 4.6 14.2 6.8C529.5 498.7 573 512 616 512c9.6 0 18.2-5.7 22-14.5c3.8-8.8 2-19-4.6-25.9c-14.2-15.6-26.2-33.7-36.6-52.1c-.9-1.7-1.9-3.4-2.8-5.1C622.8 384.1 640 345.8 640 304c0-94.4-87.9-171.5-198.2-175.8c4.1 15.2 6.2 31.2 6.2 47.8l0 .6c87.2 6.7 144 67.5 144 127.4c0 28-11.4 54.9-32.7 77.2c-14.3 15-17.3 37.6-7.5 55.8c1.1 2 2.2 4 3.2 5.9c2.5 4.5 5.2 9 7.9 13.6c-17-4.5-33.9-10.7-49.9-18c-4.3-1.9-8.5-3.9-12.6-6c-9.5-4.8-20.3-6.2-30.7-4.2c-12.1 2.4-24.7 3.6-37.8 3.6c-61.7 0-110-26.5-136.8-62.3c-16 5.4-32.8 9.4-50 11.8C279 439.8 350 480 432 480z" /></svg>

                    <small class="option__notification">5</small>
                </div>
            </div>
        </div>

        <div class="messages-explain">
            <div class="messages-explain__content">
                <div class="w-100 h-100 d-flex align-items-center justify-content-center">
                    <h2>WhatsappBro ?</h2>
                </div>
            </div>
            <div class="messages-explain__messagebox">
                <form method="post" action="/api/chats" class="form-message-send d-flex justify-content-between gap-1">
                    <div class="flex-1 w-100">
                        <input type="text" class="form-control" name="Message" placeholder="Bir mesaj giriniz..." />
                    </div>
                    <div>
                        <button class="btn-message-send btn btn-primary">Gönder</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>

<script src="~/jquery/jquery.min.js"></script>
<script src="~/microsoft-signalr/signalr.js"></script>
<script src="~/CUSTOM_JAVASCRIPT/whatsappbrotemplates.js"></script>
<script src="~/CUSTOM_JAVASCRIPT/whatsappbrochat.js"></script>
<script>
    function OnlyFriendsElementDesign() {
        $(".option").removeClass("option--selected")
        $(".option-friends").toggleClass("option--selected");
    }
    function OnlyMessagesElementDesign() {
        $(".option").removeClass("option--selected")
        $(".option-messages").toggleClass("option--selected");
    }

    $(document).ready(function () {
        $(".messages__body").hide();
        $(".searchcontainer").toggleClass("d-flex")
        $(".searchcontainer").hide()
        $(".btn-open-searchcontainer").on("click", function (e) {
            $(".searchcontainer").toggle();
        })
        $(".option-friends").on("click", function (e) {
            e.stopPropagation();
            $(".messages__body").hide()
            $(".message__friendlist").show()
            OnlyFriendsElementDesign()
        })
        $(".option-messages").on("click", function (e) {
            e.stopPropagation();
            $(".messages__body").show()
            $(".message__friendlist").hide()
            OnlyMessagesElementDesign()
        })

        $(".input-searchcontainer").on('keyup', function () {
            if ($(this).val()) {
                $.ajax({
                    type: "GET",
                    url: "/api/users/" + $(this).val(),
                    success: (data) => {
                        $(".searchcontainer-explain").html('')
                        $.each(data, function (index, item) {
                            $(".searchcontainer-explain").append(GetSearchContainerTemplate(item.id, item.userName, item.thumbnailBase64))
                        })
                    }
                })
            } else {
                $(".searchcontainer-explain").html('')
            }
        })
        $.ajax({
            type: "GET",
            url: "/api/users/friends",
            success: (data) => {
                $(".option-friends .option__notification").html(data.length)
                $.each(data, function (index, item) {
                    $(".messages__friendlist-friends-explain").append(GetSearchContainerTemplateWithMessage(item.id, item.userName, item.thumbnailBase64))
                })
            }
        })
    })
    function GetSearchContainerTemplate(id, userName, imageBase64) {
        return `<li id="${id}" class="d-flex align-items-center justify-content-between p-2" style="border-bottom:1px solid grey;">
                                                    <div class="d-flex align-items-center justify-content-start gap-2">
                                                                <img src="data:image/png;base64, ${imageBase64}" width="25" height="25" />
                                                            <h6 class="m-0">${userName}</h6>
                                                    </div>
                                                        <button class="btn btn-sm btn-outline-success" onclick="AddFriend('${id}',this)">+</button>
                                                </li>`;
    }
    function GetSearchContainerTemplateWithMessage(id, userName, imageBase64) {
        return `<li id="${id}" class="d-flex align-items-center justify-content-between p-2" style="border-bottom:1px solid grey;">
                                                        <div class="d-flex align-items-center justify-content-start gap-2">
                                                                    <img src="data:image/png;base64, ${imageBase64}" width="25" height="25" />
                                                                <h6 class="m-0">${userName}</h6>
                                                        </div>
                                                                <button class="btn btn-sm btn-outline-success" onclick="NewMessageForContainer('${id}',this)">M</button>
                                                    </li>`;
    }

    function NewMessageForContainer(id, element) {
        CreateUserContainerFriendClickEvents(id);
    }

    function AddFriend(id, button) {
        $.ajax({
            type: "POST",
            url: "/api/Users",
            data: { userId: id },
            success: () => {
                window.location.reload()
                $(button).toggle()
            }
        })
    }
</script>
<script>
    var dynamicReceiverUserId = '';
    
    

    $(document).ready(() => {

        var connection = GetSignalRConnection();
        connection.on("receiveMessage", (data) => {
            AppendDynamicMessage(data.friendId, data.friendName, data.message, data.messageDateTime, data.friendProfilePhotoBase64Thumbnail);
            CreateUserContainerClickEvents(data.friendId);
            if (dynamicReceiverUserId == data.friendId) {
                GetMessageContainerFromReceiverUser(data.message, data.messageDateTime, data.friendProfilePhotoBase64Thumbnail);
            }
            $(".messages-explain__content").animate({ scrollTop: $('.messages-explain__content')[0].scrollHeight }, 500);

        });

        GetStaticMessages()

        $(".btn-message-send").on('click', function (e) {
            e.preventDefault();
            let message = $(".form-message-send [name=Message]").val()
            $.ajax({
                type: "POST",
                url: "/api/Chats",
                data: { receiverUserId: dynamicReceiverUserId, message: message },
                success: function (result) {

                    AppendDynamicMessage(result.friendId, result.friendName, result.message, result.messageDateTime, result.friendProfilePhotoBase64Thumbnail);

                    CreateUserContainerClickEvents(result.friendId);

                    GetMessageContainerFromUser(result.message, result.messageDateTime);
                    $(".messages-explain__content").animate({ scrollTop: $('.messages-explain__content')[0].scrollHeight }, 500);

                }
            })
        })
    })

    function GetSignalRConnection() {
        var connection = new signalR.HubConnectionBuilder()
            .withUrl("https://localhost:7227/chat")
            .withAutomaticReconnect()
            .build();

        async function ConnectionOpenSignalR() {
            try {
                connection.start();
            } catch (e) {
                setTimeout(() => {
                    ConnectionOpenSignalR();
                }, 2000)
            }
        }

        ConnectionOpenSignalR();

        return connection;
    }

    function AppendDynamicMessage(userId, userName, message, time, image) {
        console.log(userId, userName, message, time)

        let messageByUser = $(`.messages__body>[id=${userId}]`)
        messageByUser.remove();

        let messageContainer = $(`.messages__body`);
        let messageTemplate = GetNewMessageTemplate(userId, userName, message, time, image);
        messageContainer.prepend(messageTemplate);
    }

    function GetStaticMessages() {
        $.ajax({
            type: "GET",
            url: "/api/chats",
            success: (data) => {
                $(".option-messages .option__notification").html(data.length)
                $.each(data, function (index, item) {
                    var temp = GetNewMessageTemplate(item.friendId, item.friendName, item.message, item.messageDateTime, item.friendProfilePhotoBase64Thumbnail);
                    $(".messages__body").append(temp);
                    CreateUserContainerClickEvents(item.friendId);
                })
            }
        })
    }

    function CreateUserContainerFriendClickEvents(userId) {
        $(`.messages__friendlist-friends-explain > [id=${userId}]`).on("click", function (params) {
            params.stopPropagation();
            dynamicReceiverUserId = $(this).attr("id");

            GetMessageContainer(userId);
            $(".messages-explain__content").animate({ scrollTop: $('.messages-explain__content')[0].scrollHeight }, 500);
        })
    }

    function CreateUserContainerClickEvents(userId) {
        $(`.user-container[id=${userId}]`).on("click", function (params) {
            params.stopPropagation();
            dynamicReceiverUserId = $(this).attr("id");

            GetMessageContainer(userId);
            $(".messages-explain__content").animate({ scrollTop: $('.messages-explain__content')[0].scrollHeight }, 500);
        })
    }

    function GetNewMessageTemplate(userId, userName, message, time, image) {
        return `<div id="${userId}" class="user-container">
                                                                                    <div class="user-container__user-logo">
                                                                                            <img src="data:image/png;base64, ${image}" width="30px" height="30px" />
                                                                                    </div>
                                                                                    <div class="user-container__user-name">
                                                                                        <div class="d-flex flex-column">
                                                                                            <a href="#">${userName}</a>
                                                                                                <span style="width: 200px;text-overflow: ellipsis;overflow: hidden;white-space: nowrap;">${message}</span>
                                                                                        </div>
                                                                                        <small>${time}</small>
                                                                                    </div>
                                                                                </div>`;
    }

    function GetMessageContainer(friendId) {
        $.ajax({
            type: "GET",
            url: "/api/Chats/" + friendId,
            success: (data) => {
                let containerTemplateResult = GetMessagesContainerTemplateHelper(data);
                let container = $(".messages-explain__content");
                container.html('');
                container.append(containerTemplateResult);
                $(".messages-explain__content").animate({ scrollTop: $('.messages-explain__content')[0].scrollHeight }, 500);

            }
        })
    }
    function GetMessageContainerFromUser(message, createdDate) {
        $.ajax({
            type: "GET",
            url: "/api/Chats/",
            success: (data) => {
                let containerTemplateResult = GetSenderMessage(message, createdDate);
                let container = $(".messages-explain__content");
                container.append(containerTemplateResult);
                $(".messages-explain__content").animate({ scrollTop: $('.messages-explain__content')[0].scrollHeight }, 500);

            }
        })
    }

    function GetMessageContainerFromReceiverUser(message, createdDate, image) {
        let containerTemplateResult = GetReceiverMessage(message, createdDate, image);
        let container = $(".messages-explain__content");
        container.append(containerTemplateResult);
        $(".messages-explain__content").animate({ scrollTop: $('.messages-explain__content')[0].scrollHeight }, 500);

    }

    function GetMessagesContainerTemplateHelper(data) {
        let template = "";
        $.each(data, function (index, item) {
            if (item.receiverId == item.ownerId) {
                template += GetReceiverMessage(item.message, item.createdDateTime, item.senderUser.thumbnailBase64)
            } else {
                template += GetSenderMessage(item.message, item.createdDateTime)
            }
        })
        return template;
    }


    function GetSenderMessage(message, time) {
        return `<div class="message-sender d-flex flex-column ">
                                            <div class="message-sender__content">
                                                <span style="width:25px;height:25px"></span>
                                                <p class="w-100 mb-0 bg-light">${message}</p>
                                            </div>
                                            <small class="w-100 text-end">${time}</small>
                                        </div>`;
    }
    function GetReceiverMessage(message, time, image) {
        return `<div class="message-receiver d-flex flex-column ">
                                            <div class="message-receiver__content">
                                                    <img src="data:image/png;base64, ${image}" width="25px" height="25px" />
                                                <p class="w-100 mb-0 bg-light">${message}</p>
                                            </div>
                                            <small class="w-100 text-end">${time}</small>
                                        </div>`;
    }


</script>
